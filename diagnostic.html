<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA Diagnostic Tool</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; background: #f5f5f5; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #333; margin-bottom: 10px; }
    .subtitle { color: #666; margin-bottom: 30px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
    .result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px; }
    .error { border-left-color: #dc3545; background: #f8d7da; }
    .success { border-left-color: #28a745; background: #d4edda; }
    pre { background: #272822; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; }
    .section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #dee2e6; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .badge.ok { background: #d4edda; color: #155724; }
    .badge.fail { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß PWA Diagnostic Tool</h1>
    <p class="subtitle">Test and fix service worker & manifest issues</p>

    <div class="section">
      <h2>Service Worker Status</h2>
      <div id="sw-status">Checking...</div>
      <button onclick="checkServiceWorker()">Check Service Worker</button>
      <button onclick="unregisterAll()" class="danger">Unregister All</button>
      <button onclick="forceUpdate()">Force Update</button>
    </div>

    <div class="section">
      <h2>Cache Status</h2>
      <div id="cache-status">Not checked</div>
      <button onclick="checkCaches()">List Caches</button>
      <button onclick="clearAllCaches()" class="danger">Clear All Caches</button>
    </div>

    <div class="section">
      <h2>Manifest Check</h2>
      <div id="manifest-status">Not checked</div>
      <button onclick="checkManifest()">Check Manifest</button>
    </div>

    <div class="section">
      <h2>Icon Tests</h2>
      <div id="icon-status">Not tested</div>
      <button onclick="testIcons()">Test Icon Paths</button>
    </div>

    <div class="section">
      <h2>Complete Reset</h2>
      <p>This will unregister all service workers, clear all caches, and reload the page fresh.</p>
      <button onclick="completeReset()" class="danger">Complete Reset & Reload</button>
    </div>

    <div id="output"></div>
  </div>

  <script>
    function log(message, type = 'result') {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.className = `result ${type}`;
      div.innerHTML = message;
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }

    async function checkServiceWorker() {
      const statusDiv = document.getElementById('sw-status');
      if (!('serviceWorker' in navigator)) {
        statusDiv.innerHTML = '<span class="badge fail">NOT SUPPORTED</span>';
        return;
      }

      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        let html = '<strong>Registrations:</strong> ' + registrations.length + '<br>';
        
        for (let reg of registrations) {
          html += `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">`;
          html += `Scope: ${reg.scope}<br>`;
          html += `Active: ${reg.active ? '‚úÖ Yes - ' + reg.active.scriptURL : '‚ùå No'}<br>`;
          html += `Installing: ${reg.installing ? 'üîÑ Yes' : 'No'}<br>`;
          html += `Waiting: ${reg.waiting ? '‚è≥ Yes' : 'No'}`;
          html += `</div>`;
        }
        
        if (navigator.serviceWorker.controller) {
          html += `<br><strong>Current controller:</strong> ${navigator.serviceWorker.controller.scriptURL}`;
        } else {
          html += `<br><strong>No active controller</strong>`;
        }

        statusDiv.innerHTML = html;
        log('Service worker status checked', 'success');
      } catch (e) {
        statusDiv.innerHTML = '<span class="badge fail">ERROR</span>';
        log('Error checking service worker: ' + e.message, 'error');
      }
    }

    async function unregisterAll() {
      if (!('serviceWorker' in navigator)) return;
      
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let reg of registrations) {
          await reg.unregister();
        }
        log(`Unregistered ${registrations.length} service worker(s)`, 'success');
        document.getElementById('sw-status').innerHTML = '<span class="badge ok">All unregistered</span>';
      } catch (e) {
        log('Error unregistering: ' + e.message, 'error');
      }
    }

    async function forceUpdate() {
      if (!('serviceWorker' in navigator)) return;
      
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (let reg of registrations) {
          await reg.update();
        }
        log('Forced update on all registrations', 'success');
        setTimeout(checkServiceWorker, 500);
      } catch (e) {
        log('Error updating: ' + e.message, 'error');
      }
    }

    async function checkCaches() {
      const statusDiv = document.getElementById('cache-status');
      try {
        const cacheNames = await caches.keys();
        let html = '<strong>Caches found:</strong> ' + cacheNames.length + '<br>';
        
        for (let name of cacheNames) {
          const cache = await caches.open(name);
          const keys = await cache.keys();
          html += `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">`;
          html += `<strong>${name}</strong> (${keys.length} items)<br>`;
          html += keys.map(req => `- ${req.url}`).join('<br>');
          html += `</div>`;
        }
        
        statusDiv.innerHTML = html || 'No caches found';
        log('Cache status checked', 'success');
      } catch (e) {
        statusDiv.innerHTML = '<span class="badge fail">ERROR</span>';
        log('Error checking caches: ' + e.message, 'error');
      }
    }

    async function clearAllCaches() {
      try {
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        log(`Cleared ${cacheNames.length} cache(s)`, 'success');
        document.getElementById('cache-status').innerHTML = '<span class="badge ok">All cleared</span>';
      } catch (e) {
        log('Error clearing caches: ' + e.message, 'error');
      }
    }

    async function checkManifest() {
      const statusDiv = document.getElementById('manifest-status');
      try {
        const response = await fetch('/manifest.json?_=' + Date.now());
        const manifest = await response.json();
        
        let html = '<pre>' + JSON.stringify(manifest, null, 2) + '</pre>';
        html += '<strong>Icon checks:</strong><br>';
        
        for (let icon of manifest.icons || []) {
          const iconResponse = await fetch(icon.src);
          const status = iconResponse.ok ? '‚úÖ' : '‚ùå';
          html += `${status} ${icon.src} (${iconResponse.status})<br>`;
        }
        
        statusDiv.innerHTML = html;
        log('Manifest checked', 'success');
      } catch (e) {
        statusDiv.innerHTML = '<span class="badge fail">ERROR</span>';
        log('Error checking manifest: ' + e.message, 'error');
      }
    }

    async function testIcons() {
      const statusDiv = document.getElementById('icon-status');
      const paths = [
        '/icons/icon-192.png',
        '/icons/icon-512.png',
        '/icons/logooo.PNG',
        'icons/logooo.PNG'
      ];
      
      let html = '<strong>Testing icon paths:</strong><br>';
      for (let path of paths) {
        try {
          const response = await fetch(path);
          const status = response.status;
          const badge = status === 200 ? '‚úÖ' : status === 204 ? '‚ö†Ô∏è' : '‚ùå';
          html += `${badge} ${path} - Status: ${status} ${response.statusText}<br>`;
        } catch (e) {
          html += `‚ùå ${path} - Error: ${e.message}<br>`;
        }
      }
      
      statusDiv.innerHTML = html;
      log('Icon paths tested', 'success');
    }

    async function completeReset() {
      if (!confirm('This will clear everything and reload. Continue?')) return;
      
      try {
        // Unregister service workers
        const registrations = await navigator.serviceWorker.getRegistrations();
        await Promise.all(registrations.map(reg => reg.unregister()));
        
        // Clear all caches
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        
        log('Complete reset successful! Reloading...', 'success');
        setTimeout(() => location.reload(), 1000);
      } catch (e) {
        log('Error during reset: ' + e.message, 'error');
      }
    }

    // Auto-check on load
    window.addEventListener('load', () => {
      checkServiceWorker();
      checkCaches();
    });
  </script>
</body>
</html>
